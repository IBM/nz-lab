
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.3.9">
    
    
      
        <title>Grooming Data - Netezza Performance Server Lab</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.1d29e8d0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=IBM+Plex+Sans:300,300i,400,400i,700,700i%7CIBM+Plex+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"IBM Plex Sans";--md-code-font:"IBM Plex Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../stylesheets/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="black">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#data-grooming" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Netezza Performance Server Lab" class="md-header__button md-logo" aria-label="Netezza Performance Server Lab" data-md-component="logo">
      
  <img src="../nz-images/IBM_logo®_rev_RGB.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Netezza Performance Server Lab
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Grooming Data
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Netezza Performance Server Lab" class="md-nav__button md-logo" aria-label="Netezza Performance Server Lab" data-md-component="logo">
      
  <img src="../nz-images/IBM_logo®_rev_RGB.png" alt="logo">

    </a>
    Netezza Performance Server Lab
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nz-01-NPS-CLI/" class="md-nav__link">
        Command Line Interface
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nz-02-WebConsole/" class="md-nav__link">
        Web Console
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nz-03-Data-Distribution/" class="md-nav__link">
        Data Distribution
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nz-04-Database-Admin/" class="md-nav__link">
        Database Administration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nz-05-Loading-and-Unloading-Data/" class="md-nav__link">
        Loading and Unloading Data
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nz-06-BNR/" class="md-nav__link">
        Backup and Restore
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nz-07-Query-Optimization/" class="md-nav__link">
        Query Optimization
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nz-08-Optimization-Objects/" class="md-nav__link">
        Optimization Objects
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Grooming Data
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Grooming Data
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-objectives" class="md-nav__link">
    1 Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-lab-setup" class="md-nav__link">
    2 Lab Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-transactions" class="md-nav__link">
    3 Transactions
  </a>
  
    <nav class="md-nav" aria-label="3 Transactions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-insert-transaction" class="md-nav__link">
    3.1 Insert Transaction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-update-and-delete-transactions" class="md-nav__link">
    3.2 Update and Delete Transactions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-aborting-transactions" class="md-nav__link">
    3.3 Aborting Transactions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-cleaning-up" class="md-nav__link">
    3.4 Cleaning up
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-grooming-logically-deleted-rows" class="md-nav__link">
    4 Grooming Logically Deleted Rows
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-performance-benefits-of-groom" class="md-nav__link">
    5 Performance Benefits of GROOM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-changing-the-data-type-of-a-column" class="md-nav__link">
    6 Changing the Data Type of a Column
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../nz-10-Stored-Proc/" class="md-nav__link">
        Stored Procedures
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_11" type="checkbox" id="__nav_11" >
      
      
      
      
        <label class="md-nav__link" for="__nav_11">
          Appendix
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Appendix" data-md-level="1">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          Appendix
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nz-disclaimer/" class="md-nav__link">
        Disclaimer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../nz-acknowledgements/" class="md-nav__link">
        Acknowledgements
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-objectives" class="md-nav__link">
    1 Objectives
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-lab-setup" class="md-nav__link">
    2 Lab Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-transactions" class="md-nav__link">
    3 Transactions
  </a>
  
    <nav class="md-nav" aria-label="3 Transactions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-insert-transaction" class="md-nav__link">
    3.1 Insert Transaction
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-update-and-delete-transactions" class="md-nav__link">
    3.2 Update and Delete Transactions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-aborting-transactions" class="md-nav__link">
    3.3 Aborting Transactions
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-cleaning-up" class="md-nav__link">
    3.4 Cleaning up
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-grooming-logically-deleted-rows" class="md-nav__link">
    4 Grooming Logically Deleted Rows
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-performance-benefits-of-groom" class="md-nav__link">
    5 Performance Benefits of GROOM
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-changing-the-data-type-of-a-column" class="md-nav__link">
    6 Changing the Data Type of a Column
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                


<h1 id="data-grooming">Data Grooming</h1>
<p>As part of your routine database maintenance activities, you should plan
to recover disk space occupied by outdated or deleted rows. In normal
Netezza Performance Server operation, an <code>UPDATE</code> or <code>DELETE</code> of a table row
does not remove the physical row on the hard disc. Instead the old row
is marked as deleted together with a transaction id of the deleting
transaction and in case of update a new row is created. This approach is
called multiversioning. Rows that could potentially be visible to other
transactions with an older transaction id are still accessible. Over
time however, the outdated or deleted rows are of no interest to any
transaction anymore and need to be removed to free up hard disc space
and improve performance. After the rows have been captured in a backup,
you can reclaim the space they occupy using the SQL <code>GROOM TABLE</code> command.
The <code>GROOM TABLE</code> command does not lock a table while it is running; you
can continue to <code>SELECT,</code> <code>UPDATE,</code> and <code>INSERT</code> into the table while the
table is being groomed.</p>
<h2 id="1-objectives">1 Objectives</h2>
<p>In this lab we will use the <code>GROOM</code> command to prepare our tables for the
customer. During the course of the POC we have deleted and update a
number of rows. At the end of a POC it is sensible to clean up the
system. Use Groom on the created tables, Generate Statistics, and other
cleanup tasks.</p>
<h2 id="2-lab-setup">2 Lab Setup</h2>
<p>This lab uses an initial setup script to make sure the correct user and
database exist for the remainder of the lab. Follow the instructions
below to run the setup script.</p>
<ol>
<li>
<p>Login to NPS Command Line using one of these two methods.</p>
<p>a.  Login to the VM directly and use the terminal application
    available inside the VM.</p>
<p>b.  Connect to your Netezza Performance Server image using putty</p>
</li>
<li>
<p>If you are continuing from the previous lab and are already
    connected to NZSQL quit the NZSQL console with the <code>\q</code>
    command.</p>
</li>
<li>
<p>Prepare for this lab by running the setup script. To do this use the
    following two commands:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">Input</label><label for="__tabbed_1_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>cd ~/labs/groom/setupLab
./setupLab.sh
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>DROP DATABASE
CREATE DATABASE
ERROR: CREATE USER: object LABADMIN already exists as a USER.
ALTER USER
ALTER DATABASE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
CREATE TABLE
Load session of table &#39;NATION&#39; completed successfully
Load session of table &#39;REGION&#39; completed successfully
Load session of table &#39;CUSTOMER&#39; completed successfully
Load session of table &#39;SUPPLIER&#39; completed successfully
Load session of table &#39;PART&#39; completed successfully
Load session of table &#39;PARTSUPP&#39; completed successfully
Load session of table &#39;ORDERS&#39; completed successfully
Load session of table &#39;LINEITEM&#39; completed successfully
</code></pre></div>
</div>
</div>
</div>
<p>There may be error message at the beginning of the output since the
script tries to clean up existing databases and users.</p>
</li>
</ol>
<h2 id="3-transactions">3 Transactions</h2>
<p>In this section we will show how transactions can leave logically
deleted rows in a table which later as an administrative task need to be
removed with the groom command. We will go through the different
transaction types and show you what happens under the covers in an
Netezza Performance Server Appliance.</p>
<h3 id="31-insert-transaction">3.1 Insert Transaction</h3>
<p>In this chapter we will add a new row to the regions table and review
the hidden fields that are saved in the database. As you remember from
the Transactions presentation, Netezza Performance Server uses a concept
called multi-versioning for transactions. Each transaction has its own
image of the table and doesn't influence other transactions. This is
done by adding a number of hidden fields to the Netezza Performance
Server table. The most important ones are the <code>CREATEXID</code> and the
<code>DELETEXID</code>. Each Netezza Performance Server transaction has a unique
transaction id that is increasing with each new transaction.</p>
<p>In this subsection we will add a new row to the <code>REGION</code> table.</p>
<ol>
<li>
<p>Connect to your NPS system using a terminal application (i.e.: PuTTY
        or Terminal). Login to <code>&lt;ip-provided-by-your-instructor&gt;</code> as user nz
        with password nz. (<code>&lt;ip-provided-by-your-instructor&gt;</code> is the default
        IP address for a lab system).</p>
</li>
<li>
<p>Start nzsql from the Linux command line as following:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">Input</label><label for="__tabbed_2_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsql
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>    Welcome to nzsql, the IBM Netezza SQL interactive terminal.

Type: \h for help with SQL commands
      \? for help on internal slash commands
      \g or terminate with semicolon to execute query
      \q to quit

SYSTEM.ADMIN(ADMIN)=&gt;
</code></pre></div>
</div>
</div>
</div>
<p>You will be entered into the nzsql interactive terminal.</p>
</li>
<li>
<p>Connect to the database <code>LABDB</code> as user <code>LABADMIN</code> by typing the
        following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">Input</label><label for="__tabbed_3_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>\c LABDB LABADMIN
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>You are now connected to database LABDB as user LABADMIN.
LABDB.ADMIN(LABADMIN)=&gt;
</code></pre></div>
</div>
</div>
</div>
<p>Notice the prompt has changed to show the new connection information.</p>
</li>
<li>
<p>Select all rows from the <code>REGION</code> table:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">Input</label><label for="__tabbed_4_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT * FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code> R_REGIONKEY |          R_NAME           |          R_COMMENT
-------------+---------------------------+-----------------------------
           3 | emea                      | europe, middle east, africa
           1 | na                        | north america
           2 | sa                        | south america
           4 | ap                        | asia pacific
(4 rows)
</code></pre></div>
</div>
</div>
</div>
<p>You should see the following output with 4 existing regions.</p>
</li>
<li>
<p>Insert a new row into the <code>REGIONS</code> table for the region Australia
        with the following SQL command</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">Input</label><label for="__tabbed_5_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>INSERT INTO REGION VALUES (5, &#39;as&#39;, &#39;australia&#39;);
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>INSERTED 0 1
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Now we will again do a select on the <code>REGION</code> table. But this time we
        will also query the hidden fields <code>CREATEXID,</code> <code>DELETEXID</code> and <code>ROWID</code>:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">Input</label><label for="__tabbed_6_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT CREATEXID, DELETEXID, ROWID,* FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code> CREATEXID | DELETEXID |  ROWID   | R_REGIONKEY |          R_NAME           |          R_COMMENT
-----------+-----------+----------+-------------+---------------------------+-----------------------------
     17498 |         0 | 28765000 |           3 | emea                      | europe, middle east, africa
     17498 |         0 | 28765001 |           1 | na                        | north america
     17498 |         0 | 28765002 |           2 | sa                        | south america
     17498 |         0 | 28765003 |           4 | ap                        | asia pacific
     17514 |         0 | 37428000 |           5 | as                        | australia
(5 rows)
</code></pre></div>
</div>
</div>
</div>
<p>As you can see, we now have five rows in the <code>REGION</code> table. The new row
for Australia has the ID of the last transaction as <code>CREATEXID</code> and 0 as
DELETEXID since it has not yet been deleted. Other transactions with a
lower transaction ID that might still be running will not be able to
see this new row. Note also that each row has a unique <code>ROWID</code>. <code>ROWID</code>s
do not need to be consecutive, but they are unique across all data
slices for one table.</p>
</li>
</ol>
<h3 id="32-update-and-delete-transactions">3.2 Update and Delete Transactions</h3>
<p>Delete transactions in Netezza Performance Server do not physically
remove rows but update the <code>DELETEXID</code> field of a row to mark it as
logically deleted. These logically deleted rows need to be removed
regularly with the administrative <code>GROOM</code> command.</p>
<p>Update transactions in Netezza Performance Server consist of a logical
delete of the old row and an insert of a new row with the updated
fields. To show this effectively we will need to change a system
parameter in Netezza Performance Server that allows us to switch off the
invisibility lists in Netezza Performance Server. Note that the
parameter we will be using is dangerous and shouldn't be used in a real
Netezza Performance Server environment. There is also a safer
environment variable, but this has some restrictions.</p>
<p>To see deleted rows without changing the system registry parameters do
the following:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:1"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="__tabbed_7_1">Registry Parameters</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsql labdb labadmin password

set show_deleted_records = true;
select * from table_with_deleted_rows;
set show_deleted_records = false;
</code></pre></div>
</div>
</div>
</div>
<p>The above method is not used in this lab, please follow the steps
below.</p>
<ol>
<li>
<p>First, we will change the system variable that allows us to see
        deleted rows in the system, to do this exit the console with <code>\q</code>.</p>
</li>
<li>
<p>Check the Netezza Performance Server system registry for the
        parameters host.fpgaAllowXIDOverride and system.useFpgaPrep, each
        should be set to yes:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="8:2"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><div class="tabbed-labels"><label for="__tabbed_8_1">Input</label><label for="__tabbed_8_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsystem showregistry | grep -iE &#39;fpgaAllowXIDOverride|useFpgaPrep&#39;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>host.fpgaAllowXIDOverride = no
system.useFpgaPrep = yes
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>To change these system parameters, first pause the system with the
        following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="9:1"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><div class="tabbed-labels"><label for="__tabbed_9_1">Input</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsystem pause
Are you sure you want to pause the system (y|n)? [n] y
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Next, update the system parameters with the following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="10:1"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><div class="tabbed-labels"><label for="__tabbed_10_1">Input</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsystem set -arg host.fpgaAllowXIDOverride=yes
Are you sure you want to change the system configuration (y|n)? [n] y
</code></pre></div>
</div>
</div>
</div>
<p>Ensure both parameters <code>host.fpgaAllowXIDOverride</code> and
<code>system.useFpgaPrep</code> are set to <code>yes</code>.</p>
</li>
<li>
<p>Resume the system with the following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="11:1"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><div class="tabbed-labels"><label for="__tabbed_11_1">Input</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsystem resume
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Re-check the Netezza Performance Server system registry for the
        parameters <code>host.fpgaAllowXIDOverride</code> and <code>system.useFpgaPrep</code>, each
        should be set to yes:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="12:2"><input checked="checked" id="__tabbed_12_1" name="__tabbed_12" type="radio" /><input id="__tabbed_12_2" name="__tabbed_12" type="radio" /><div class="tabbed-labels"><label for="__tabbed_12_1">Input</label><label for="__tabbed_12_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsystem showregistry | grep -iE &#39;fpgaAllowXIDOverride|useFpgaPrep&#39;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>host.fpgaAllowXIDOverride = yes
system.useFpgaPrep = yes
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Start <code>nzsql</code> from the Linux command line as following:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="13:1"><input checked="checked" id="__tabbed_13_1" name="__tabbed_13" type="radio" /><div class="tabbed-labels"><label for="__tabbed_13_1">Input</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsql labdb labadmin password
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Now we will update the row we inserted in the last chapter to the
        <code>REGION</code> table:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="14:1"><input checked="checked" id="__tabbed_14_1" name="__tabbed_14" type="radio" /><div class="tabbed-labels"><label for="__tabbed_14_1">Input</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>UPDATE REGION SET R_COMMENT=&#39;Australia&#39; WHERE R_REGIONKEY=5;
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Do a <code>SELECT</code> on the <code>REGION</code> table again:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="15:2"><input checked="checked" id="__tabbed_15_1" name="__tabbed_15" type="radio" /><input id="__tabbed_15_2" name="__tabbed_15" type="radio" /><div class="tabbed-labels"><label for="__tabbed_15_1">Input</label><label for="__tabbed_15_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT CREATEXID, DELETEXID, ROWID,* FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code> CREATEXID | DELETEXID |  ROWID   | R_REGIONKEY |          R_NAME           |          R_COMMENT
-----------+-----------+----------+-------------+---------------------------+-----------------------------
     17498 |         0 | 28765000 |           3 | emea                      | europe, middle east, africa
     17498 |         0 | 28765001 |           1 | na                        | north america
     17498 |         0 | 28765002 |           2 | sa                        | south america
     17498 |         0 | 28765003 |           4 | ap                        | asia pacific
     17514 |     21506 | 37428000 |           5 | as                        | australia
     21506 |         0 | 37428000 |           5 | as                        | Australia
(6 rows)
</code></pre></div>
</div>
</div>
</div>
<p>Normally you would now see 5 rows with the update value. But since we
disabled the invisibility lists you now see 6 rows in the <code>REGION</code>
table. Our transaction that updated the row had the transaction id
369666. You can see that the original row with the lowercase australia
in the comment column is still there and now has a <code>DELETXID</code> field that
contains the transaction id of the transaction that deleted it.
Transactions with a higher transaction id will not see a row with a
<code>DELETEXID</code> that indicates that it has been logically deleted before the
transaction is run.</p>
<p>We also see a newly inserted row with the new comment value Australia.
It has the same <code>ROWID</code> as the deleted row and the same <code>CREATEXID</code> as the
transaction that did the insert.</p>
</li>
<li>
<p>Finally let's clean up the table again by deleting the Australia
        row:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="16:2"><input checked="checked" id="__tabbed_16_1" name="__tabbed_16" type="radio" /><input id="__tabbed_16_2" name="__tabbed_16" type="radio" /><div class="tabbed-labels"><label for="__tabbed_16_1">Input</label><label for="__tabbed_16_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>DELETE FROM REGION WHERE R_REGIONKEY=5;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>DELETE 1
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Do a <code>SELECT</code> on the <code>REGION</code> table again:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="17:2"><input checked="checked" id="__tabbed_17_1" name="__tabbed_17" type="radio" /><input id="__tabbed_17_2" name="__tabbed_17" type="radio" /><div class="tabbed-labels"><label for="__tabbed_17_1">Input</label><label for="__tabbed_17_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT CREATEXID, DELETEXID, ROWID,* FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code> CREATEXID | DELETEXID |  ROWID   | R_REGIONKEY |          R_NAME           |          R_COMMENT
-----------+-----------+----------+-------------+---------------------------+-----------------------------
     17498 |         0 | 28765000 |           3 | emea                      | europe, middle east, africa
     17498 |         0 | 28765001 |           1 | na                        | north america
     17498 |         0 | 28765002 |           2 | sa                        | south america
     17498 |         0 | 28765003 |           4 | ap                        | asia pacific
     17514 |     21506 | 37428000 |           5 | as                        | australia
     21506 |     21510 | 37428000 |           5 | as                        | Australia
(6 rows)
</code></pre></div>
</div>
</div>
</div>
<p>We can now see that we have logically deleted our updated row as well.
It has now a <code>DELETEXID</code> field with the value of the new transaction.
New transactions will see the original table from the start of this
lab again.</p>
<p>If you do a <code>SELECT</code>, the FPGA will filter out all rows that:</p>
<ul>
<li>
<p>have a <code>CREATEXID</code> which is bigger than the current transaction id.</p>
</li>
<li>
<p>have a <code>CREATEXID</code> of an uncommitted transaction.</p>
</li>
<li>
<p>have a <code>DELETENXID</code> which is smaller than the current transaction, but
    only if the transaction of the <code>DELETEXID</code> field is committed.</p>
</li>
<li>
<p>have a <code>DELETEXID</code> of 1 which means that the insert has been aborted.</p>
</li>
</ul>
</li>
</ol>
<h3 id="33-aborting-transactions">3.3 Aborting Transactions</h3>
<p>Netezza Performance Server never deletes a row during transactions even
if transactions are rolled back. In this section we will show what
happens if a transaction is rolled back. Since an update transaction
consists of a <code>DELETE</code> and <code>INSERT</code> transaction, we will demonstrate the
behavior for all tree transaction types with this.</p>
<ol>
<li>
<p>To start a transaction that we can later rollback we need to use the
        <code>BEGIN</code> keyword.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="18:2"><input checked="checked" id="__tabbed_18_1" name="__tabbed_18" type="radio" /><input id="__tabbed_18_2" name="__tabbed_18" type="radio" /><div class="tabbed-labels"><label for="__tabbed_18_1">Input</label><label for="__tabbed_18_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>BEGIN;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>BEGIN
</code></pre></div>
</div>
</div>
</div>
<p>Per default all SQL statements entered into the nzsql console are
auto-committed. To start a multi command transaction the <code>BEGIN</code> keyword
needs to be used. All SQL statements that are executed after it will
belong to a single transaction. To end the transaction two keywords
can be used <code>COMMIT</code> to commit the transaction or <code>ROLLBACK</code> to rollback
the transaction and all changes since the <code>BEGIN</code> statement was
executed.</p>
</li>
<li>
<p>Update the row for the AP region:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="19:2"><input checked="checked" id="__tabbed_19_1" name="__tabbed_19" type="radio" /><input id="__tabbed_19_2" name="__tabbed_19" type="radio" /><div class="tabbed-labels"><label for="__tabbed_19_1">Input</label><label for="__tabbed_19_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>UPDATE REGION SET R_COMMENT=&#39;AP&#39; WHERE R_REGIONKEY=4;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>UPDATE 1
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Do a <code>SELECT</code> on the <code>REGION</code> table again:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="20:2"><input checked="checked" id="__tabbed_20_1" name="__tabbed_20" type="radio" /><input id="__tabbed_20_2" name="__tabbed_20" type="radio" /><div class="tabbed-labels"><label for="__tabbed_20_1">Input</label><label for="__tabbed_20_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT CREATEXID, DELETEXID, ROWID,* FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code> CREATEXID | DELETEXID |  ROWID   | R_REGIONKEY |          R_NAME           |          R_COMMENT
-----------+-----------+----------+-------------+---------------------------+-----------------------------
     17498 |         0 | 28765000 |           3 | emea                      | europe, middle east, africa
     17498 |         0 | 28765001 |           1 | na                        | north america
     17498 |         0 | 28765002 |           2 | sa                        | south america
     17498 |     21514 | 28765003 |           4 | ap                        | asia pacific
     17514 |     21506 | 37428000 |           5 | as                        | australia
     21506 |     21510 | 37428000 |           5 | as                        | Australia
     21514 |         0 | 28765003 |           4 | ap                        | AP
(7 rows)
</code></pre></div>
</div>
</div>
</div>
<p>Note: we have the same results as in the last chapter, the original
row for the AP region was logically deleted by updating its <code>DELETEXID</code>
field, and a new row with the updated comment and new <code>ROWID</code> has been
added. Note that its <code>CREATEXID</code> is the same as the <code>DELETEXID</code> of the old
row, since they were updated by the same transaction.</p>
</li>
<li>
<p>Now let's rollback the transaction:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="21:2"><input checked="checked" id="__tabbed_21_1" name="__tabbed_21" type="radio" /><input id="__tabbed_21_2" name="__tabbed_21" type="radio" /><div class="tabbed-labels"><label for="__tabbed_21_1">Input</label><label for="__tabbed_21_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ROLLBACK;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ROLLBACK
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Do a <code>SELECT</code> on the <code>REGION</code> table again:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="22:2"><input checked="checked" id="__tabbed_22_1" name="__tabbed_22" type="radio" /><input id="__tabbed_22_2" name="__tabbed_22" type="radio" /><div class="tabbed-labels"><label for="__tabbed_22_1">Input</label><label for="__tabbed_22_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT CREATEXID, DELETEXID, ROWID,* FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code> CREATEXID | DELETEXID |  ROWID   | R_REGIONKEY |          R_NAME           |          R_COMMENT
-----------+-----------+----------+-------------+---------------------------+-----------------------------
     17498 |         0 | 28765000 |           3 | emea                      | europe, middle east, africa
     17498 |         0 | 28765001 |           1 | na                        | north america
     17498 |         0 | 28765002 |           2 | sa                        | south america
     17498 |         0 | 28765003 |           4 | ap                        | asia pacific
     17514 |     21506 | 37428000 |           5 | as                        | australia
     21506 |     21510 | 37428000 |           5 | as                        | Australia
     21514 |         1 | 28765003 |           4 | ap                        | AP
(7 rows)
</code></pre></div>
</div>
</div>
</div>
<p>We can see that the transaction has been rolled back. The <code>DELETEXID</code> of
the old version of the row has been reset to 0, which means that it is
a valid row that can be seen by other transactions, and the <code>DELETEXID</code>
of the new row has been set to 1 which marks it as aborted.</p>
</li>
</ol>
<h3 id="34-cleaning-up">3.4 Cleaning up</h3>
<p>In this section we will use the <code>GROOM</code> command to remove the logically
deleted rows we have entered, and we will remove the system parameter
from the configuration file. The <code>GROOM</code> command will be used in more
detail in the next chapter. It is the main maintenance command in
Netezza Performance Server, and we have already used it in the
Cluster-based Table labs to reorder a CBT. It also removes all logically
deleted rows from a table and frees up the space on the machine again.</p>
<ol>
<li>
<p>Execute the <code>GROOM</code> command on the <code>REGION</code> table:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="23:2"><input checked="checked" id="__tabbed_23_1" name="__tabbed_23" type="radio" /><input id="__tabbed_23_2" name="__tabbed_23" type="radio" /><div class="tabbed-labels"><label for="__tabbed_23_1">Input</label><label for="__tabbed_23_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>GROOM TABLE REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>NOTICE: Groom will not purge records deleted by transactions that
started after 2020-04-02 19:18:49.

NOTICE: Groom processed 1 pages; purged 3 records; scan size unchanged;
table size unchanged.

GROOM RECORDS ALL
</code></pre></div>
</div>
</div>
</div>
<p>You can see that the <code>GROOM</code> command purged 3 rows, exactly the number
of aborted and logically deleted rows we have generated in the
previous chapter.</p>
</li>
<li>
<p>Now select the rows from the <code>REGION</code> table again.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="24:2"><input checked="checked" id="__tabbed_24_1" name="__tabbed_24" type="radio" /><input id="__tabbed_24_2" name="__tabbed_24" type="radio" /><div class="tabbed-labels"><label for="__tabbed_24_1">Input</label><label for="__tabbed_24_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT CREATEXID, DELETEXID, ROWID,* FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code> CREATEXID | DELETEXID |  ROWID   | R_REGIONKEY |          R_NAME           |          R_COMMENT
-----------+-----------+----------+-------------+---------------------------+-----------------------------
     17498 |         0 | 28765000 |           3 | emea                      | europe, middle east, africa
     17498 |         0 | 28765001 |           1 | na                        | north america
     17498 |         0 | 28765002 |           2 | sa                        | south america
     17498 |         0 | 28765003 |           4 | ap                        | asia pacific
(4 rows)
</code></pre></div>
</div>
</div>
</div>
<p>You can see that the <code>GROOM</code> command has removed all logically deleted
rows from the table. Remember that we still have the parameter
switched on that allows us to see any logically deleted rows.
Especially in tables that are heavily changed with lots and updates
and deletes running the groom command will free up hard drive space
and increase performance.</p>
</li>
<li>
<p>Finally, we will change the system variables back to the original
        settings, to do this exit the console with <code>\q</code>.</p>
</li>
<li>
<p>To change these system parameters, first pause the system with the
        following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="25:1"><input checked="checked" id="__tabbed_25_1" name="__tabbed_25" type="radio" /><div class="tabbed-labels"><label for="__tabbed_25_1">Input</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsystem pause
Are you sure you want to pause the system (y|n)? [n]  y
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Next, update the system parameters with the following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="26:1"><input checked="checked" id="__tabbed_26_1" name="__tabbed_26" type="radio" /><div class="tabbed-labels"><label for="__tabbed_26_1">Input</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsystem set -arg host.fpgaAllowXIDOverride=no
Are you sure you want to change the system configuration (y|n)? [n] y
</code></pre></div>
</div>
</div>
</div>
<p>Ensure both parameters <code>host.fpgaAllowXIDOverride=no</code> and
<code>system.useFpgaPrep=yes</code>.</p>
</li>
<li>
<p>Resume the system with the following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="27:1"><input checked="checked" id="__tabbed_27_1" name="__tabbed_27" type="radio" /><div class="tabbed-labels"><label for="__tabbed_27_1">Input</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsystem resume
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Re-check the Netezza Performance Server system registry for the
        parameters <code>host.fpgaAllowXIDOverride</code> and <code>system.useFpgaPrep</code>, each
        should be set to yes:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="28:2"><input checked="checked" id="__tabbed_28_1" name="__tabbed_28" type="radio" /><input id="__tabbed_28_2" name="__tabbed_28" type="radio" /><div class="tabbed-labels"><label for="__tabbed_28_1">Input</label><label for="__tabbed_28_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsystem showregistry | grep -iE &#39;fpgaAllowXIDOverride|useFpgaPrep&#39;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>host.fpgaAllowXIDOverride = no
system.useFpgaPrep = yes
</code></pre></div>
</div>
</div>
</div>
</li>
</ol>
<h2 id="4-grooming-logically-deleted-rows">4 Grooming Logically Deleted Rows</h2>
<p>In this section we will delete rows and determine that they have not
really been deleted from the disk. Then using <code>GROOM</code> we will physically
delete the rows.</p>
<ol>
<li>
<p>First determine the physical size on disk of the table <code>ORDERS</code> using
        the following command:</p>
<p>You should see the following results:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="29:2"><input checked="checked" id="__tabbed_29_1" name="__tabbed_29" type="radio" /><input id="__tabbed_29_2" name="__tabbed_29" type="radio" /><div class="tabbed-labels"><label for="__tabbed_29_1">Input</label><label for="__tabbed_29_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>/nz/support/bin/nz_db_size LABDB
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>  Object   |               Name               |        Bytes         |        KB        |      MB      |     GB     |   TB
-----------+----------------------------------+----------------------+------------------+--------------+------------+--------
 Appliance | localhost                        |          452,984,832 |          442,368 |          432 |         .4 |     .0
 Database  | LABDB                            |          452,984,832 |          442,368 |          432 |         .4 |     .0
   .schema | ADMIN                            |          452,984,832 |          442,368 |          432 |         .4 |     .0
 Table     | CUSTOMER                         |           13,107,200 |           12,800 |           13 |         .0 |     .0
 Table     | LINEITEM                         |          284,688,384 |          278,016 |          272 |         .3 |     .0
 Table     | NATION                           |              131,072 |              128 |            0 |         .0 |     .0
 Table     | ORDERS                           |           76,283,904 |           74,496 |           73 |         .1 |     .0
 Table     | PART                             |           11,534,336 |           11,264 |           11 |         .0 |     .0
 Table     | PARTSUPP                         |           66,322,432 |           64,768 |           63 |         .1 |     .0
 Table     | REGION                           |              131,072 |              128 |            0 |         .0 |     .0
 Table     | SUPPLIER                         |              786,432 |              768 |            1 |         .0 |     .0
</code></pre></div>
</div>
</div>
</div>
<p>Notice that the <code>ORDERS</code> table is 75 MB in size.</p>
</li>
<li>
<p>Now we are going to delete some rows from <code>ORDERS</code> table. Delete all
        rows where the <code>ORDERSTATUS</code> is marked as F for finished using the
        following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="30:2"><input checked="checked" id="__tabbed_30_1" name="__tabbed_30" type="radio" /><input id="__tabbed_30_2" name="__tabbed_30" type="radio" /><div class="tabbed-labels"><label for="__tabbed_30_1">Input</label><label for="__tabbed_30_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsql LABDB LABADMIN password
DELETE FROM ORDERS WHERE O_ORDERSTATUS=&#39;F&#39;;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>DELETE 729413
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Now check the physical table size for <code>ORDERS</code> and see if the size
        decreased using the same command as before. You must first exit
        nzsql to shell using <code>\q</code>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="31:2"><input checked="checked" id="__tabbed_31_1" name="__tabbed_31" type="radio" /><input id="__tabbed_31_2" name="__tabbed_31" type="radio" /><div class="tabbed-labels"><label for="__tabbed_31_1">Input</label><label for="__tabbed_31_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>\q
/nz/support/bin/nz_db_size LABDB
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>  Object   |               Name               |        Bytes         |        KB        |      MB      |     GB     |   TB
-----------+----------------------------------+----------------------+------------------+--------------+------------+--------
 Appliance | localhost                        |          452,984,832 |          442,368 |          432 |         .4 |     .0
 Database  | LABDB                            |          452,984,832 |          442,368 |          432 |         .4 |     .0
   .schema | ADMIN                            |          452,984,832 |          442,368 |          432 |         .4 |     .0
 Table     | CUSTOMER                         |           13,107,200 |           12,800 |           13 |         .0 |     .0
 Table     | LINEITEM                         |          284,688,384 |          278,016 |          272 |         .3 |     .0
 Table     | NATION                           |              131,072 |              128 |            0 |         .0 |     .0
 Table     | ORDERS                           |           76,283,904 |           74,496 |           73 |         .1 |     .0
 Table     | PART                             |           11,534,336 |           11,264 |           11 |         .0 |     .0
 Table     | PARTSUPP                         |           66,322,432 |           64,768 |           63 |         .1 |     .0
 Table     | REGION                           |              131,072 |              128 |            0 |         .0 |     .0
 Table     | SUPPLIER                         |              786,432 |              768 |            1 |         .0 |     .0
</code></pre></div>
</div>
</div>
</div>
<p>The output should be the same as above showing that the <code>ORDERS</code> table
did not change in size and is still 75 MB. This is because the deleted
rows were logically deleted but are still left on disk. The rows will
still accessible to transactions that started before the <code>DELETE</code>
statement which we just executed. (i.e. have a lower transaction id)</p>
</li>
<li>
<p>Next let's physically delete what we just logically deleted using
        the <code>GROOM TABLE</code> command and specifying table <code>ORDERS</code>. When you run
        the <code>GROOM TABLE</code> command, it removes outdated and deleted records
        from tables.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="32:2"><input checked="checked" id="__tabbed_32_1" name="__tabbed_32" type="radio" /><input id="__tabbed_32_2" name="__tabbed_32" type="radio" /><div class="tabbed-labels"><label for="__tabbed_32_1">Input</label><label for="__tabbed_32_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsql LABDB LABADMIN password
GROOM TABLE ORDERS;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>NOTICE: Groom will not purge records deleted by transactions that
started after 2020-04-02 19:56:57.

NOTICE: Groom processed 582 pages; purged 729413 records; scan size
shrunk by 280 pages; table size shrunk by 12 extents.

GROOM RECORDS ALL
</code></pre></div>
</div>
</div>
</div>
<p>You can see that 729413 rows were removed from disk resulting in the
table size shrinking by 12 extents. Notice that this is the same
number of rows we deleted in the previous step.</p>
</li>
<li>
<p>Check if the <code>ORDERS</code> table size on disk has shrunk using the
        <code>nz_db_size</code> command. You must first exit <code>nzsql</code> to shell using <code>\q</code>.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="33:2"><input checked="checked" id="__tabbed_33_1" name="__tabbed_33" type="radio" /><input id="__tabbed_33_2" name="__tabbed_33" type="radio" /><div class="tabbed-labels"><label for="__tabbed_33_1">Input</label><label for="__tabbed_33_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>\q
/nz/support/bin/nz_db_size LABDB
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>  Object   |               Name               |        Bytes         |        KB        |      MB      |     GB     |   TB
-----------+----------------------------------+----------------------+------------------+--------------+------------+--------
 Appliance | localhost                        |          416,284,672 |          406,528 |          397 |         .4 |     .0
 Database  | LABDB                            |          416,284,672 |          406,528 |          397 |         .4 |     .0
   .schema | ADMIN                            |          416,284,672 |          406,528 |          397 |         .4 |     .0
 Table     | CUSTOMER                         |           13,107,200 |           12,800 |           13 |         .0 |     .0
 Table     | LINEITEM                         |          284,688,384 |          278,016 |          272 |         .3 |     .0
 Table     | NATION                           |              131,072 |              128 |            0 |         .0 |     .0
 Table     | ORDERS                           |           39,583,744 |           38,656 |           38 |         .0 |     .0
 Table     | PART                             |           11,534,336 |           11,264 |           11 |         .0 |     .0
 Table     | PARTSUPP                         |           66,322,432 |           64,768 |           63 |         .1 |     .0
 Table     | REGION                           |              131,072 |              128 |            0 |         .0 |     .0
 Table     | SUPPLIER                         |              786,432 |              768 |            1 |         .0 |     .0
</code></pre></div>
</div>
</div>
</div>
<p>Notice the reduced size of the <code>ORDERS</code> table. We can see that <code>GROOM</code> did
purge the deleted rows from disk. <code>GROOM</code> reported that the table size
was reduced by 12 extents and we can confirm this because we can see
that the size of the table reduced by 36MB which is the correct size
for 12 extents. (1 extent's size is 3 MB).</p>
</li>
</ol>
<h2 id="5-performance-benefits-of-groom">5 Performance Benefits of GROOM</h2>
<p>In this section we will show that grooming a table can also result in a
performance benefit because the amount of data that needs to be scanned
is smaller. Outdated rows are still present on the hard disc. They can
be dismissed by the FPGA but the system still needs to read them from
disc. In this example we need for accounting reasons increase the order
price of all columns. This means that we need to update every row in the
<code>ORDERS</code> table. We will measure query performance before and after
Grooming the table.</p>
<ol>
<li>
<p>Update the <code>ORDERS</code> table so that the price of everything is increased
        by $1. Do this using the following command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="34:2"><input checked="checked" id="__tabbed_34_1" name="__tabbed_34" type="radio" /><input id="__tabbed_34_2" name="__tabbed_34" type="radio" /><div class="tabbed-labels"><label for="__tabbed_34_1">Input</label><label for="__tabbed_34_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>nzsql LABDB LABADMIN password
UPDATE ORDERS SET O_TOTALPRICE = O_TOTALPRICE+1;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>UPDATE 770587
</code></pre></div>
</div>
</div>
</div>
<p>All rows will be affected by the update resulting in a doubled number
of physical rows in the table. This is because the <code>UPDATE</code> operation
leaves a copy of the rows before the <code>UPDATE</code> occurred in case a
transaction is still operating on the rows. New rows are created, and
the results of the <code>UPDATE</code> are put in these rows. The old rows that are
left on disk are marked as logically deleted.</p>
</li>
<li>
<p>To measure the performance of our test query, we can configure the
        nzsql console to show the elapsed execution time using the following
        command:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="35:2"><input checked="checked" id="__tabbed_35_1" name="__tabbed_35" type="radio" /><input id="__tabbed_35_2" name="__tabbed_35" type="radio" /><div class="tabbed-labels"><label for="__tabbed_35_1">Input</label><label for="__tabbed_35_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>\time
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>Query time printout on
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Run our given test query and note the performance:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="36:2"><input checked="checked" id="__tabbed_36_1" name="__tabbed_36" type="radio" /><input id="__tabbed_36_2" name="__tabbed_36" type="radio" /><div class="tabbed-labels"><label for="__tabbed_36_1">Input</label><label for="__tabbed_36_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT COUNT(*) FROM ORDERS;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>COUNT
--------
770587
(1 row)

Elapsed time: 0m0.641s
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Please rerun the query once or twice more to see roughly what a
        consistent query time is on your machine.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="37:1"><input checked="checked" id="__tabbed_37_1" name="__tabbed_37" type="radio" /><div class="tabbed-labels"><label for="__tabbed_37_1">Input</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT COUNT(*) FROM ORDERS;
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Now run the <code>GROOM TABLE</code> command on the <code>ORDER</code> table again:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="38:2"><input checked="checked" id="__tabbed_38_1" name="__tabbed_38" type="radio" /><input id="__tabbed_38_2" name="__tabbed_38" type="radio" /><div class="tabbed-labels"><label for="__tabbed_38_1">Input</label><label for="__tabbed_38_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>GROOM TABLE ORDERS;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>NOTICE: Groom will not purge records deleted by transactions that
started after 2020-04-02 20:12:07.

NOTICE: Groom processed 604 pages; purged 770587 records; scan size
shrunk by 302 pages; table size shrunk by 13 extents.

GROOM RECORDS ALL

Elapsed time: 0m2.026s
</code></pre></div>
</div>
</div>
</div>
<p>Can you tell how much disk space this saved? (It's the number of
extents times 3MB)</p>
</li>
<li>
<p>Now run our chosen test query again and you should see a difference
        in performance:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="39:2"><input checked="checked" id="__tabbed_39_1" name="__tabbed_39" type="radio" /><input id="__tabbed_39_2" name="__tabbed_39" type="radio" /><div class="tabbed-labels"><label for="__tabbed_39_1">Input</label><label for="__tabbed_39_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT COUNT(*) FROM ORDERS;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>COUNT
--------
770587
(1 row)
Elapsed time: 0m0.082s
</code></pre></div>
</div>
</div>
</div>
<p>You should see that the query ran faster than before. This is because
<code>GROOM</code> reduced the number of rows that must be scanned to complete the
query. The <code>COUNT(*)</code> command on the table will return the same number
of rows before and after the <code>GROOM</code> command was run since it can only
see the current version of the table, which means all rows that have
not been deleted by a lower transaction id. Since our <code>UPDATE</code> command
hasn't changed the number of logical rows this will not change.</p>
<p>Nevertheless, the outdated rows, which have been logically deleted by
our <code>UPDATE</code> command, are still present on disk. The <code>COUNT(*)</code> query
cannot access these rows but they do take up space on disk and need to
be scanned. <code>GROOM</code> is used to purge these logically deleted rows from
disk which increase disk usage and scan distance. You should <code>GROOM</code>
tables that receive frequent updates or deletes more often than tables
that are seldom updated. You might want to schedule tasks that
routinely <code>GROOM</code> the frequently updated tables or run a <code>GROOM</code> command
as part of you ETL process.</p>
</li>
</ol>
<h2 id="6-changing-the-data-type-of-a-column">6 Changing the Data Type of a Column</h2>
<p>In some situations, you will realize that the initially used data types
are not suitable for long-term use, for example because new entries
exceed the range of an initially picked integer value. You cannot
directly change the data type by using the <code>ALTER</code> statement but there are
two approaches that allow you to do it without loading and unloading the
data.</p>
<p>The first approach is to:</p>
<ul>
<li>
<p>Create a CTAS table from the old table with a <code>CAST</code> to the new
    datatype for the column you want to change</p>
</li>
<li>
<p>Drop the old table</p>
</li>
<li>
<p>Rename the new table to the name of the old table</p>
</li>
</ul>
<p>In general, this is a good approach because it lets you keep the order
of the columns. But in this example, we will use a second approach to
highlight the groom command and its role during <code>ADD</code> and <code>DROP</code> column
commands. Its disadvantages are that the order of the columns will
change, which may result in difficulties for third party applications
that access columns by their order.</p>
<p>In this chapter we will:</p>
<ul>
<li>
<p>Add a new column to the table with the new datatype</p>
</li>
<li>
<p>Copy over all values from the old row to the new one with an <code>UPDATE</code>
    command</p>
</li>
<li>
<p>Drop the old column</p>
</li>
<li>
<p>Rename the new column to the name of the old one</p>
</li>
<li>
<p>Use the groom command to materialize the results of our table
    changes</p>
</li>
</ul>
<p>For our example we find out that we have a new Region we want to add to
our <code>REGIONS</code> table which has a name that exceeds the limits of the
<code>CHAR(25)</code> field <code>R_NAME</code>. "Australia, New Zealand, and Tasmania". And we
decide to increase the <code>R_NAME</code> field to a <code>CHAR(40)</code> field.</p>
<ol>
<li>
<p>Add a new column to the region table with name <code>R_NAME_TEMP</code> and data
        type <code>CHAR(40)</code></p>
<div class="tabbed-set tabbed-alternate" data-tabs="40:4"><input checked="checked" id="__tabbed_40_1" name="__tabbed_40" type="radio" /><input id="__tabbed_40_2" name="__tabbed_40" type="radio" /><input id="__tabbed_40_3" name="__tabbed_40" type="radio" /><input id="__tabbed_40_4" name="__tabbed_40" type="radio" /><div class="tabbed-labels"><label for="__tabbed_40_1">Timer ON</label><label for="__tabbed_40_2">Output</label><label for="__tabbed_40_3">ALTER TABLE</label><label for="__tabbed_40_4">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>\time
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>Query time printout on
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ALTER TABLE REGION ADD COLUMN R_NAME_TEMP CHAR(40);
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ALTER TABLE
</code></pre></div>
</div>
</div>
</div>
<p>Notice that the <code>ALTER</code> command is practically instantaneous. This even
holds true for huge tables. Under the cover the system will create a
new empty version of the table. It will not lock and change the whole
table.</p>
</li>
<li>
<p>Let's insert a row into the table using the new name column</p>
<div class="tabbed-set tabbed-alternate" data-tabs="41:2"><input checked="checked" id="__tabbed_41_1" name="__tabbed_41" type="radio" /><input id="__tabbed_41_2" name="__tabbed_41" type="radio" /><div class="tabbed-labels"><label for="__tabbed_41_1">Input</label><label for="__tabbed_41_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>INSERT INTO REGION VALUES
    (5,&#39;&#39;, &#39;South Pacific Region&#39;,
    &#39;Australia, New Zealand, and Tasmania&#39;);
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>INSERT 0 1
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Now do a select on the table:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="42:2"><input checked="checked" id="__tabbed_42_1" name="__tabbed_42" type="radio" /><input id="__tabbed_42_2" name="__tabbed_42" type="radio" /><div class="tabbed-labels"><label for="__tabbed_42_1">Input</label><label for="__tabbed_42_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT * FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>R_REGIONKEY  |          R_NAME           |          R_COMMENT          |               R_NAME_TEMP
-------------+---------------------------+-----------------------------+------------------------------------------
           3 | emea                      | europe, middle east, africa |
           1 | na                        | north america               |
           2 | sa                        | south america               |
           4 | ap                        | asia pacific                |
           5 |                           | South Pacific Region        | Australia, New Zealand, and Tasmania
(5 rows)
</code></pre></div>
</div>
</div>
</div>
<p>You can see that the results are exactly as you would expect them to
be, but how does the system actually achieve this. Remember inside the
Netezza Performance Server appliances we have two versions of the
table, one containing the old columns and rows and one containing the
new row column.</p>
</li>
<li>
<p>Let's do an <code>EXPLAIN</code> on the <code>SELECT</code> query</p>
<div class="tabbed-set tabbed-alternate" data-tabs="43:2"><input checked="checked" id="__tabbed_43_1" name="__tabbed_43" type="radio" /><input id="__tabbed_43_2" name="__tabbed_43" type="radio" /><div class="tabbed-labels"><label for="__tabbed_43_1">Input</label><label for="__tabbed_43_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>EXPLAIN VERBOSE SELECT * FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>NOTICE:  QUERY PLAN:


QUERY SQL:

EXPLAIN VERBOSE SELECT * FROM REGION;



QUERY VERBOSE PLAN:

Node 1.
  [SPU Sequential Scan table &quot;&quot;_TV_203063_2&quot;&quot; {(&quot;_TV_203063_2&quot;.R_REGIONKEY)}]
      -- Estimated Rows = 1, Width = 221, Cost = 0.0 .. 0.0, Conf = 100.0
      User table: REGION version 2
      Projections:
        1:&quot;_TV_203063_2&quot;.R_REGIONKEY  2:&quot;_TV_203063_2&quot;.R_NAME
        3:&quot;_TV_203063_2&quot;.R_COMMENT  4:&quot;_TV_203063_2&quot;.R_NAME_TEMP
Node 2.
  [SPU Sub-query Scan table &quot;*SELECT* 1&quot; Node &quot;1&quot; {(0.&quot;1&quot;)}]
      -- Estimated Rows = 1, Width = 221, Cost = 0.0 .. 0.0, Conf = 0.0
      Projections:
        1:0.&quot;1&quot;  2:0.&quot;2&quot;  3:0.&quot;3&quot;  4:0.&quot;4&quot;
Node 3.
  [SPU Sequential Scan table &quot;&quot;_TV_203063_1&quot;&quot; {(&quot;_TV_203063_1&quot;.R_REGIONKEY)}]
      -- Estimated Rows = 4, Width = 221, Cost = 0.0 .. 0.0, Conf = 100.0
      User table: REGION version 1
      Projections:
        1:&quot;_TV_203063_1&quot;.R_REGIONKEY  2:&quot;_TV_203063_1&quot;.R_NAME
        3:&quot;_TV_203063_1&quot;.R_COMMENT  4:(NULL::BPCHAR)::CHAR(40)
Node 4.
  [SPU Sub-query Scan table &quot;*SELECT* 2&quot; Node &quot;3&quot; {(0.&quot;1&quot;)}]
      -- Estimated Rows = 4, Width = 221, Cost = 0.0 .. 0.0, Conf = 0.0
      Projections:
        1:0.&quot;1&quot;  2:0.&quot;2&quot;  3:0.&quot;3&quot;  4:0.&quot;4&quot;
Node 5.
  [SPU Append Nodes: , &quot;2&quot;, &quot;4 (stream)&quot; {(0.&quot;1&quot;)}]
      -- Estimated Rows = 5, Width = 221, Cost = 0.0 .. 0.0, Conf = 0.0
      Projections:
        1:0.&quot;1&quot;  2:0.&quot;2&quot;  3:0.&quot;3&quot;  4:0.&quot;4&quot;
Node 6.
  [SPU Sub-query Scan table &quot;_BV_203063&quot; Node &quot;5&quot; {(&quot;_BV_203063&quot;.R_REGIONKEY)}]
      -- Estimated Rows = 5, Width = 221, Cost = 0.0 .. 0.0, Conf = 100.0
      Projections:
        1:&quot;_BV_203063&quot;.R_REGIONKEY  2:&quot;_BV_203063&quot;.R_NAME  3:&quot;_BV_203063&quot;.R_COMMENT
        4:&quot;_BV_203063&quot;.R_NAME_TEMP
  [SPU Return]
  [Host Return]


QUERY PLANTEXT:

Sub-query Scan table &quot;_BV_203063&quot; (cost=0.0..0.0 rows=5 width=221 conf=100) {(&quot;_BV_203063&quot;.R_REGIONKEY)}
(xpath_none, locus=spu subject=self)
(xpath_none, locus=spu subject=self)
(xpath_none, locus=spu subject=self)
(spu_send, locus=host subject=self)
(host_return, locus=host subject=self)
   l: Append (cost=0.0..0.0 rows=5 width=221 conf=0) {(0.&quot;1&quot;)}
      (xpath_none, locus=spu subject=self)
      (xpath_none, locus=spu subject=self)
      a: Sub-query Scan table &quot;*SELECT* 1&quot; (cost=0.0..0.0 rows=1 width=221 conf=0) {(0.&quot;1&quot;)}
         (xpath_none, locus=spu subject=self)
         l: Sequential Scan table &quot;&quot;_TV_203063_2&quot;&quot; (cost=0.0..0.0 rows=1 width=221 conf=100)  {(&quot;_TV_203063_2&quot;.R_REGIONKEY)}
            (User table: REGION version 2)
            (xpath_none, locus=spu subject=self)
      a: Sub-query Scan table &quot;*SELECT* 2&quot; (cost=0.0..0.0 rows=4 width=221 conf=0) {(0.&quot;1&quot;)}
         (xpath_none, locus=spu subject=self)
         l: Sequential Scan table &quot;&quot;_TV_203063_1&quot;&quot; (cost=0.0..0.0 rows=4 width=221 conf=100)  {(&quot;_TV_203063_1&quot;.R_REGIONKEY)}
            (User table: REGION version 1)
            (xpath_none, locus=spu subject=self)



EXPLAIN
</code></pre></div>
</div>
</div>
</div>
<p>Normally the query would result in a single table scan node. But now
we see a more complicated query plan. The Optimizer automatically
translates the simple <code>SELECT</code> into a <code>UNION</code> of two tables. The two
tables are internal and are called <code>TV_203063_1</code>, which is the old
version of the table before the <code>ALTER</code> statement. And
<code>TV_203063_2</code>, which is the new version of the table after the
table statement containing the new column <code>R_NAME_TEMP</code>.</p>
<p>Notice that in the old table a 4th column of <code>CHAR(40)</code> with default
value <code>NULL</code> is added. This is necessary for the <code>UNION</code> to succeed. The
merger of those tables is done in Node 5, which takes both result sets
and appends them.</p>
<p>But let's proceed with our data type change operation.</p>
</li>
<li>
<p>Let's remove the new row again.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="44:2"><input checked="checked" id="__tabbed_44_1" name="__tabbed_44" type="radio" /><input id="__tabbed_44_2" name="__tabbed_44" type="radio" /><div class="tabbed-labels"><label for="__tabbed_44_1">Input</label><label for="__tabbed_44_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>DELETE FROM REGION WHERE R_REGIONKEY &gt; 4;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>DELETE 1
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Now we will move all values of the <code>R_NAME</code> column to the <code>R_NAME_TEMP</code>
        column by updating them</p>
<div class="tabbed-set tabbed-alternate" data-tabs="45:2"><input checked="checked" id="__tabbed_45_1" name="__tabbed_45" type="radio" /><input id="__tabbed_45_2" name="__tabbed_45" type="radio" /><div class="tabbed-labels"><label for="__tabbed_45_1">Input</label><label for="__tabbed_45_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>UPDATE REGION SET R_NAME_TEMP = R_NAME;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>UPDATE 4
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Let's have a look at the table again:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="46:2"><input checked="checked" id="__tabbed_46_1" name="__tabbed_46" type="radio" /><input id="__tabbed_46_2" name="__tabbed_46" type="radio" /><div class="tabbed-labels"><label for="__tabbed_46_1">Input</label><label for="__tabbed_46_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT * FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>R_REGIONKEY  |          R_NAME           |          R_COMMENT          |               R_NAME_TEMP
-------------+---------------------------+-----------------------------+------------------------------------------
           3 | emea                      | europe, middle east, africa | emea
           1 | na                        | north america               | na
           2 | sa                        | south america               | sa
           4 | ap                        | asia pacific                | ap
(4 rows)
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Now let's remove the old column:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="47:2"><input checked="checked" id="__tabbed_47_1" name="__tabbed_47" type="radio" /><input id="__tabbed_47_2" name="__tabbed_47" type="radio" /><div class="tabbed-labels"><label for="__tabbed_47_1">Input</label><label for="__tabbed_47_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ALTER TABLE REGION DROP COLUMN R_NAME RESTRICT;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ALTER TABLE
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Rename the column name <code>R_NAME_TEMP</code> to <code>R_NAME</code></p>
<div class="tabbed-set tabbed-alternate" data-tabs="48:2"><input checked="checked" id="__tabbed_48_1" name="__tabbed_48" type="radio" /><input id="__tabbed_48_2" name="__tabbed_48" type="radio" /><div class="tabbed-labels"><label for="__tabbed_48_1">Input</label><label for="__tabbed_48_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ALTER TABLE REGION RENAME COLUMN R_NAME_TEMP TO R_NAME;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ALTER TABLE
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Let's have a look at the table again:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="49:2"><input checked="checked" id="__tabbed_49_1" name="__tabbed_49" type="radio" /><input id="__tabbed_49_2" name="__tabbed_49" type="radio" /><div class="tabbed-labels"><label for="__tabbed_49_1">Input</label><label for="__tabbed_49_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>SELECT * FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>R_REGIONKEY  |          R_COMMENT          |                  R_NAME
-------------+-----------------------------+------------------------------------------
           3 | europe, middle east, africa | emea
           1 | north america               | na
           2 | south america               | sa
           4 | asia pacific                | ap
(4 rows)
</code></pre></div>
</div>
</div>
</div>
<p>We have achieved to change the data type of the <code>R_NAME</code> column. The
column order has changed but our <code>R_NAME</code> column has the same values as
before and now supports longer region names.</p>
<p>But we have one last step to do. Under the cover the system now has
three different versions of the table which are merged for each call
against the <code>REGION</code> table. This not only uses up space it is also bad
for the query performance. So, we have to materialize these table
changes with the <code>GROOM</code> command.</p>
</li>
<li>
<p><code>GROOM</code> the <code>REGION</code> table with the <code>VERSIONS</code> keyword to merge table
        versions:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="50:2"><input checked="checked" id="__tabbed_50_1" name="__tabbed_50" type="radio" /><input id="__tabbed_50_2" name="__tabbed_50" type="radio" /><div class="tabbed-labels"><label for="__tabbed_50_1">Input</label><label for="__tabbed_50_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>GROOM TABLE REGION VERSIONS;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>NOTICE: Groom will not purge records deleted by transactions that
started after 2020-04-03 04:04:56.
NOTICE: If this process is interrupted please either repeat GROOM
VERSIONS or issue &#39;GENERATE STATISTICS ON &quot;REGION&quot;&#39;
NOTICE: Groom processed 2 pages; purged 5 records; scan size shrunk by 1
pages; table size shrunk by 1 extents.

GROOM VERSIONS
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Finally, we will look at the <code>EXPLAIN</code> output again:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="51:2"><input checked="checked" id="__tabbed_51_1" name="__tabbed_51" type="radio" /><input id="__tabbed_51_2" name="__tabbed_51" type="radio" /><div class="tabbed-labels"><label for="__tabbed_51_1">Input</label><label for="__tabbed_51_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>EXPLAIN VERBOSE SELECT * FROM REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>NOTICE:  QUERY PLAN:


QUERY SQL:

EXPLAIN VERBOSE SELECT * FROM REGION;


QUERY VERBOSE PLAN:

Node 1.
  [SPU Sequential Scan table &quot;REGION&quot; {(REGION.R_REGIONKEY)}]
      -- Estimated Rows = 4, Width = 196, Cost = 0.0 .. 0.0, Conf = 100.0
      Projections:
        1:REGION.R_REGIONKEY  2:REGION.R_COMMENT  3:REGION.R_NAME
  [SPU Return]
  [Host Return]


QUERY PLANTEXT:

Sequential Scan table &quot;REGION&quot; (cost=0.0..0.0 rows=4 width=196 conf=100)  {(REGION.R_REGIONKEY)}
(xpath_none, locus=spu subject=self)
(spu_send, locus=host subject=self)
(host_return, locus=host subject=self)


EXPLAIN
</code></pre></div>
</div>
</div>
</div>
<p>Now this is much nicer. As we would expect we only have a single table
scan snippet in the query plan and a single version of the <code>REGION</code>
table.</p>
</li>
<li>
<p>Finally, we will return the <code>REGION</code> table to the old column ordering
        to not interfere with future labs, to do this we will use a CTAS
        statement</p>
<div class="tabbed-set tabbed-alternate" data-tabs="52:2"><input checked="checked" id="__tabbed_52_1" name="__tabbed_52" type="radio" /><input id="__tabbed_52_2" name="__tabbed_52" type="radio" /><div class="tabbed-labels"><label for="__tabbed_52_1">Input</label><label for="__tabbed_52_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>CREATE TABLE REGION_NEW AS
  SELECT R.R_REGIONKEY, R.R_NAME, R.R_COMMENT
FROM REGION R;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>INSERT 0 4
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Now drop the <code>REGION</code> table:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="53:2"><input checked="checked" id="__tabbed_53_1" name="__tabbed_53" type="radio" /><input id="__tabbed_53_2" name="__tabbed_53" type="radio" /><div class="tabbed-labels"><label for="__tabbed_53_1">Input</label><label for="__tabbed_53_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>DROP TABLE REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>DROP TABLE
</code></pre></div>
</div>
</div>
</div>
</li>
<li>
<p>Finally, rename the <code>REGION_NEW</code> table to make the transformation
        complete:</p>
<div class="tabbed-set tabbed-alternate" data-tabs="54:2"><input checked="checked" id="__tabbed_54_1" name="__tabbed_54" type="radio" /><input id="__tabbed_54_2" name="__tabbed_54" type="radio" /><div class="tabbed-labels"><label for="__tabbed_54_1">Input</label><label for="__tabbed_54_2">Output</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ALTER TABLE REGION_NEW RENAME TO REGION;
</code></pre></div>
</div>
<div class="tabbed-block">
<div class="highlight"><pre><span></span><code>ALTER TABLE
</code></pre></div>
</div>
</div>
</div>
<p>If a table can be inaccessible for a short period of time using CTAS
tables can be the better solution to change data types than using an
<code>ALTER TABLE</code> statement.</p>
</li>
</ol>
<div class="admonition success">
<p class="admonition-title">Congratulations on finishing the chapter!</p>
<p>In this lab you have looked behind the scenes of the Netezza Performance
Server appliances. You have seen how transactions are implemented and we
have shown different reasons for using the groom command. It not only
removes logically deleted rows from <code>INSERT</code> and <code>UPDATE</code> operations,
aborted <code>INSERTS</code> and Loads, it also materializes table changes and
reorders cluster-based tables.</p>
</div>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../nz-08-Optimization-Objects/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Optimization Objects" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Optimization Objects
            </div>
          </div>
        </a>
      
      
        
        <a href="../nz-10-Stored-Proc/" class="md-footer__link md-footer__link--next" aria-label="Next: Stored Procedures" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Stored Procedures
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2024 IBM
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.annotate"], "search": "../assets/javascripts/workers/search.b97dbffb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6c7ad80a.min.js"></script>
      
    
  </body>
</html>